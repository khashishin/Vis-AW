<!DOCTYPE html>
<meta charset="utf-8">
<style>
.node {
    stroke: #fff;
    stroke-width: 1.5px;
}

.node text {
  pointer-events: none;
  font: 12px sans-serif;
  fill : black;
}

.link {
    stroke: #999;
    stroke-opacity: .6;
}

#selected {
  position:absolute;
  background-color: WHITE;
  border-radius: 4px;
  bottom: 0px;
  font: 12px sans-serif;
}

#header {
font: 50px arial;
margin: auto;
width: 38%;
}

#textInput{
position: fixed;
font: 28px arial;
}

#slider {
font:32px arial;
}
</style>




<body>

<div id="header">Wizualizacja dendrytu wrocławskiego</div>
  
<form>
    <div id="slider"> 
	Wartość Krytyczna K:  0     <input type="range" id="thersholdSlider" name="points" value = 0 min="0" max="4" onchange="threshold(this.value);  updateTextInput(this.value)" >     4
	</div>
	
	<input type="text" id="textInput" value="" readonly size="1">
	
</form>
  
<div id='visualisation'>
<div id='selected'> <h1>Info</h1> </div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
<script type="application/json" id="mis">
{
  "nodes": [
    {
      "node": 0
    },
    {
      "node": 1
    },
    {
      "node": 2
    },
    {
      "node": 3
    },
    {
      "node": 4
    },
    {
      "node": 5
    },
    {
      "node": 6
    },
    {
      "node": 7
    },
    {
      "node": 8
    },
    {
      "node": 9
    },
    {
      "node": 10
    },
    {
      "node": 11
    },
    {
      "node": 12
    },
    {
      "node": 13
    },
    {
      "node": 14
    },
    {
      "node": 15
    },
    {
      "node": 16
    }
  ],
  "links": [
    {
      "source": 5,
      "length": 50,
      "target": 6,
      "bond": 1
    },
    {
      "source": 6,
      "length": 50,
      "target": 7,
      "bond": 1
    },
    {
      "source": 7,
      "length": 50,
      "target": 9,
      "bond": 1
    },
    {
      "source": 0,
      "length": 50,
      "target": 4,
      "bond": 1
    },
    {
      "source": 16,
      "length": 50,
      "target": 1,
      "bond": 1
    },
    {
      "source": 1,
      "length": 43,
      "target": 3,
      "bond": 2
    },
    {
      "source": 2,
      "length": 43,
      "target": 4,
      "bond": 2
    },
    {
      "source": 13,
      "length": 43,
      "target": 15,
      "bond": 2
    },
    {
      "source": 11,
      "length": 43,
      "target": 15,
      "bond": 2
    },
    {
      "source": 15,
      "length": 43,
      "target": 9,
      "bond": 2
    },
    {
      "source": 12,
      "length": 43,
      "target": 15,
      "bond": 2
    },
	{
      "source": 14,
      "length": 43,
      "target": 2,
      "bond": 1
    },
		{
      "source": 10,
      "length": 86,
      "target": 8,
      "bond": 1
    },
		{
      "source": 1,
      "length": 86,
      "target": 14,
      "bond": 1
    },
		{
      "source": 2,
      "length": 106,
      "target": 6,
      "bond": 1
    },
		{
      "source": 8,
      "length": 126,
      "target": 16,
      "bond": 1
    }
  ]
}
</script>

<script>
//Reading threshold value from html slider element
function updateTextInput(val) { document.getElementById('textInput').value=val; }

//Constants for the SVG image that will be the background for our visualisation
var width = 2550,
    height = 1100
	r = 8;

//Append a SVG to the body of the html page. Assign this SVG as an object to svg
var svg = d3.select("#visualisation").append("svg")
    .attr("width", width)
    .attr("height", height);
	
//Definind ounding box that will b shown on visualisation
svg.append("svg:rect")
    .attr("width", width)
    .attr("height", height)
    .style("stroke", "#000")
	.style("fill", "WHITE");
	
//Set up the colour scale that will be used for differentiating nodes
var color = d3.scale.category20();

//Set up the force layout that is the base for showing nodes and graphs
var force = d3.layout.force()
    .charge(-120)
	//Gravity value defines eg. the behaviour of nodes when in unconnected state (how strong is the force of attraction/rejection between them )
	.gravity(0.012)
    .linkDistance(function(d) { return d.length;})
    .size([width, height]);

//Read the data from the mis element in HTML
var mis = document.getElementById('mis').innerHTML;
graph = JSON.parse(mis);
graphRec = JSON.parse(JSON.stringify(graph)); //This line is used so the programm can read threshold values to cut

//Creates the graph data structure out of the json data that is imported into D3 force layout
force.nodes(graph.nodes)
    .links(graph.links)
    .start();
  
//Create all the line svgs in group marker, so we can add things to it if we want later (g) - empty, without coordinates
var link = svg.selectAll("g")
    .data(graph.links)
    .enter()
	.append("line")
    .attr("class", "link")
	.style("stroke-width", function(d) {if (d.bond>1) return (d.bond * 2 - 1) * 2 + "px"; })

//The same with nodes (circles)
var node = svg.selectAll("g")
    .data(graph.nodes)
    .enter()
	.append("g")
	.call(force.drag)
	.on("click", selectPoint)
	.on('dblclick', connectedNodes)	//Highlithing;

//Append SVG circle to the (g) element
var circles = node.append("circle")
    .attr("class", "node")
    .attr("r", r)
    .style("fill", function (d) {return color(d.node);})
	.style("stroke", "gray")
	
//Append text label to the element
var TextLabels = node.append("text")
				 .text(function(d) {return d.node; })

//Now we are giving the SVGs co-ordinates - the force layout is generating the co-ordinates which this code is using to update the attributes of the SVG elements
force.on("tick", function () {
    link.attr("x1", function (d) {return d.source.x;})
        .attr("y1", function (d) {return d.source.y;})
        .attr("x2", function (d) {return d.target.x;})
        .attr("y2", function (d) {return d.target.y;});
		
	circles.attr("cx", function(d) { return d.x = Math.max(r, Math.min(width - r*2, d.x)); })
        .attr("cy", function(d) { return d.y = Math.max(r, Math.min(height - r*2, d.y)); });

	TextLabels
	    .attr("x", function (d) {return d.x;})
        .attr("y", function (d) {return d.y;});
});


//Adjust cutting/splicing links threshold
function threshold(thresh) {
//!!!!!!!!!!!!!!!!!!!!TODO WARTOSC KRYTYCZNA HARDCODED NA 40 DO POPRAWY!!!!!!!!!!!!!!!!!!!!
    graph.links.splice(0, graph.links.length);
		for (var i = 0; i < graphRec.links.length; i++) {
			if (graphRec.links[i].length > thresh*40) {graph.links.push(graphRec.links[i]);}
		}
    restart();
}

// What happens when you click node in graph
function selectPoint(d) {
	d3.select('#selected h1')
      .text("User: "+ d.node)
}

//Restart the visualisation after any node and link changes
function restart() {
	link = link
	.data(graph.links)
	.style("stroke-width", function(d) {if (d.bond>1) return (d.bond * 2 - 1) * 2 + "px"; })
	link.exit().remove();
	link
		.enter()
		.insert("line","g")
		.attr("class", "link")
		.style("stroke-width", function(d) {if (d.bond>1) return (d.bond * 2 - 1) * 2 + "px"; })
	force.start();
}

// Connected nodes doubleclick highlight
//Toggle stores whether the highlighting is on
var toggle = 0;
//Create an array logging what is connected to what
var linkedByIndex = {};
for (i = 0; i < graph.nodes.length; i++) {
    linkedByIndex[i + "," + i] = 1;
};
graph.links.forEach(function (d) {
    linkedByIndex[d.source.index + "," + d.target.index] = 1;
});

function neighboring(a, b) {
    return linkedByIndex[a.index + "," + b.index];
}

function connectedNodes() {
    if (toggle == 0) {
        //Reduce the opacity of all but the neighbouring nodes
        d = d3.select(this).node().__data__;
        node.style("opacity", function (o) {return neighboring(d, o) | neighboring(o, d) ? 1 : 0.1;});
        link.style("opacity", function (o) {return d.index==o.source.index | d.index==o.target.index ? 1 : 0.1;});
        //Reduce the opacity
        toggle = 1;}
	
	else {
        //Put them back to opacity=1
        node.style("opacity", 1);
        link.style("opacity", 1);
        toggle = 0;}
}
</script>